module RbManager
  module Helpers
    def is_malware_enabled
      credentials_file = '/root/.s3cfg_malware_initial'
      if ::File.exist?(credentials_file)
        mcli_malware_data = `mcli alias list 2>/dev/null | grep -A 6 '^malware'`
        parsed_mcli_data = if mcli_malware_data.nil? || mcli_malware_data.empty?
                             {}
                           else
                             mcli_malware_data.lines.map do |line|
                               parts = line.split(':').map(&:strip)
                               next if parts.empty? || parts[0].nil? || parts[0].empty?

                               key = parts[0]
                               # Join the rest of the parts in case the value contains colons
                               value = parts[1..].join(':').strip
                               [key, value]
                             end.compact.to_h
                           end
        mcli_data_missing = mcli_malware_data.nil? || mcli_malware_data.empty?
        parsed_data_missing = parsed_mcli_data.nil? || parsed_mcli_data.empty?
        access_key_invalid = parsed_mcli_data['AccessKey'] == 'malware'
        secret_key_invalid = parsed_mcli_data['SecretKey'] == 'malware'

        if mcli_data_missing || parsed_data_missing || access_key_invalid || secret_key_invalid
          Chef::Log.warn('Malware MinIO alias is not configured properly in mcli.')
          false
        else
          true
        end
      else
        Chef::Log.warn("Malware s3 credentials file #{credentials_file} does not exist.")
        false
      end
    end
  end
end
