#!/bin/bash
# Script to execute rb_create_druid_metadata.rb script daily in cron

service="riak"
if [ ! -f "/etc/init.d/$service" ]; then
 exit 1
fi

service $service status > /dev/null
if [ $? != 0 ]; then
   exit 1
fi

date=$(date -d '-1 day' '+%Y-%m-%d')
namespaces=$(/bin/s3cmd ls s3://bucket/rbdata/ | cut -d "/" -f 5)
bucket="bucket"
if [ -f /etc/externals.conf ]; then
  remote_bucket=$(cat /etc/externals.conf | grep S3BUCKET | cut -d "=" -f 2)
  echo $remote_bucket
  if [ $remote_bucket != '""' ]; then
    bucket=$remote_bucket
  fi
fi

for ns in $namespaces; do
  /usr/lib/redborder/scripts/rb_create_druid_metadata.rb -d $ns -b $bucket -t $ns -u -g $date >> /var/log/daily_druid_metadata.log
done
